"use strict";function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c,d=0;d<b.length;d++)c=b[d],c.enumerable=c.enumerable||!1,c.configurable=!0,"value"in c&&(c.writable=!0),Object.defineProperty(a,c.key,c)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){if(Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a)){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!(b&&c.length===b));d=!0);}catch(a){e=!0,f=a}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}}function _arrayWithHoles(a){if(Array.isArray(a))return a}var ջթ=Sactory,ջժ=ջթ.chain,ջի={};Sactory.addWidget("message",function(a){var b=ջթ.cfa(ջի,arguments,1);return ջժ(b,[ջժ.create,"span",0,[]],[ջժ.body,function(b){ջթ.bind(b,[a],[],function(a,b){for(var c,d=b.map(ջթ.value),e=_slicedToArray(d,1),f=e[0],g=f.matchAll(/`[^`]*`/g),h=0;!(c=g.next()).done;)ջժ(a,[ջժ.update,[[5,"text",f.substring(h,h=c.value.index)]]]),ջժ(a,[ջժ.create,"code",0,[[5,"text",c.value[0].slice(1,-1)]]],[ջժ.append]),h+=c.value[0].length;ջժ(a,[ջժ.update,[[5,"text",f.substr(h)]]])})}],[ջժ.append])});var Sandbox=function(){function Sandbox(a){var b=this,c=a.readonly,d=a.embedded,e=a.name,f=a.mode,g=a.head,h=a.source;_classCallCheck(this,Sandbox),this.debug=ջթ.cofv(!1).localStorage("sandbox_debug"),this.es6=ջթ.cofv(this.checkES6()).localStorage("sandbox_es6"),this.hideResult=ջթ.cofv(!1).localStorage("sandbox_hide_result"),this.lastId=ջթ.cofv(0).localStorage("sandbox_id"),this.currentId=ջթ.cofv(0).localStorage("sandbox_curr_id"),this.readonly=ջթ.cofv(!!c),this.data={name:ջթ.cofv(""),description:ջթ.cofv(""),mode:ջթ.cofv("auto-code@logic"),head:ջթ.cofv(""),source:ջթ.cofv("")};var i=window.location.hash&&decode(window.location.hash.substr(1));i?(this.readonly.value=!0,i.name&&(this.data.name.value=i.name),i.mode&&(this.data.mode.value=i.mode),i.head&&(this.data.head.value=i.head),i.source&&(this.data.source.value=i.source)):d?(e&&(this.data.name.value=e),f&&(this.data.mode.value=f),g&&(this.data.head.value=g),h&&(this.data.source.value=h)):(this.reloadStorage(),this.saveStorage()),this.data.editorSource=this.data.source.value,this.result=ջթ.coff(function(){try{return Transpiler.transpile({filename:b.data.name.value,mode:b.data.mode.value,es6:b.es6.value,sandboxed:!0},b.data.source.value)}catch(a){return console.error(a),{error:a}}}).async().d(this.data.name,this.data.mode,this.es6,this.data.source),this.srcdoc=ջթ.coff(function(){return"".concat(b.data.head.value,"<script src=\"").concat(DIST,"sactory.min.js\"></script><script>Sactory.ready(function(){").concat(b.result.value.source&&b.result.value.source.all,"})</script>")}).d(this.data.head,this.result,this.result),this.settings=ջթ.cofv(!1),this.snippets=ջթ.coff(function(){if(b.settings.value){for(var a,c=[],d=0;d<=b.lastId.value;d++)a=window.localStorage.getItem("sandbox__"+d),a&&c.push(Object.assign(JSON.parse(a),{id:d}));return c.sort(function(c,a){return a.modified-c.modified})}return[]}).d(this.settings)}return _createClass(Sandbox,[{key:"checkES6",value:function checkES6(){try{return eval("() => {}"),!0}catch(a){return!1}}},{key:"reloadStorageImpl",value:function reloadStorageImpl(a){var b=window.localStorage.getItem("sandbox__"+a);if(b){var c=JSON.parse(b);this.data.name.value=c.name,this.data.description.value=c.description,this.data.mode.value=c.mode,this.data.head.value=c.head,this.data.source.value=c.source}}},{key:"reloadStorage",value:function reloadStorage(){this.reloadStorageImpl(this.currentId.value)}},{key:"saveStorage",value:function saveStorage(){var a=this,b=ջթ.cfa(ջի,arguments,0);if(!this.saving){var c=ջթ.coff(function(){return JSON.stringify({name:a.data.name.value,description:a.data.description.value,mode:a.data.mode.value,head:a.data.head.value,source:a.data.source.value,modified:new Date().getTime()})}).async().d(this.data.name,this.data.description,this.data.mode,this.data.head,this.data.source);c.$$subscribe(b,function(b){return window.localStorage.setItem("sandbox__"+a.currentId.value,b)}),this.saving=!0}}},{key:"plus",value:function plus(){this.currentId.value=++this.lastId.value,this.readonly.value?(this.readonly.value=!1,this.saveStorage()):(this.data.name.value="",this.data.description.value="",this.data.mode.value="auto-code@logic",this.data.head.value="",this.data.source.value="")}},{key:"openImpl",value:function openImpl(a,b){window.open("".concat(ROOT).concat(a,"#").concat(encode(b)))}},{key:"open",value:function open(){this.openImpl("sandbox",this.data)}},{key:"fullscreen",value:function fullscreen(){this.openImpl("fullscreen",{name:this.data.name.value,srcdoc:this.srcdoc.value})}},{key:"load",value:function load(a){this.settings.value=!1,this.readonly.value=!1,this.reloadStorageImpl(this.currentId.value=a)}},{key:"remove",value:function remove(a,b){window.confirm("Are you sure you want to delete \"".concat(a,"\"? This action cannot be undone."))&&(delete window.localStorage["sandbox__"+b],this.snippets._calc())}},{key:"save",value:function save(){this.data.source.update(this.data.editorSource,8934)}},{key:"initCodeMirror",value:function initCodeMirror(a,b,c){var d=CodeMirror.fromTextArea(a,{lineNumbers:!0,indentWithTabs:!0,tabSize:4,smartIndent:!1,lineWrapping:!0,theme:"sactory",readOnly:b,mode:c});return d.setSize("100%","100%"),d}},{key:"initSourceEditor",value:function initSourceEditor(a){var b=this,c=ջթ.cfa(ջի,arguments,1),d=this.initCodeMirror(a,this.readonly.value,"jsx");d.on("change",function(){return b.data.editorSource=d.getValue()}),this.data.source.$$subscribe(c,function(a){return d.setValue(a)},8934),ջժ(c,[ջժ.use,a.nextElementSibling],[ջժ.update,[[3,ջթ.attr(ջթ.config.s.save,":prevent"),function(){b.save()}]]]),this.readonly.value&&this.readonly.$$subscribe(c,function(){return d.setOption("readOnly",!1)})}},{key:"initResultEditor",value:function initResultEditor(a){var b=ջթ.cfa(ջի,arguments,1),c=this.initCodeMirror(a,!0,"javascript");this.result.$$subscribe(b,function(a){return c.setValue(a.source&&a.source.contentOnly||"")})}},{key:"render",value:function render(a){var b=this,c=a.orientation,d=void 0===c?"x":c,e=a.hide,f=void 0===e?[]:e,g=a.embedded,h=ջթ.cfa(ջի,arguments,1);return ջժ(h,[ջժ.create,"div",0,[[0,"data-orientation",d],[5,"class:hide-result",ջթ.bo(function(){return b.hideResult.value},[this.hideResult])]]],[ջժ.body,function(a){ջթ.forEachArray(f,function(b){ջժ(a,[ջժ.update,[[5,"class","hide-".concat(b)]]])}),ջժ(a,[ջժ.create,"div",0,[[0,"class","top"],[5,"show",ջթ.bo(function(){return!b.settings.value},[b.settings])]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"div",0,[[0,"class","actions"]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"div",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"div",0,[[0,"class","left"]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"input",0,[[0,"class","input"],[0,"placeholder","Name"],[1,"disabled",ջթ.bo(function(){return b.readonly.value},[b.readonly])]]],[ջժ.bind,["value","::change",ջթ.bo(function(){return b.data.name.value},[b.data.name]),function(a){b.data.name.value=a}]],[ջժ.append])}],[ջժ.append]),ջժ(a,[ջժ.create,"div",0,[[0,"class","right"]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"div",0,[[0,"class","buttons"]]],[ջժ.body,function(a){g||(ջժ(a,[ջժ.create,"button",0,[[0,"class","button default"],[3,"click",function(){b.settings.value=!0}]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"i",0,[[0,"class","fas fa-cog"]]],[ջժ.append])}],[ջժ.append]),ջժ(a,[ջժ.create,"button",0,[[0,"class","button default"],[3,"click",function(){b.plus()}]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"i",0,[[0,"class","fas fa-plus"]]],[ջժ.append])}],[ջժ.append]),ջթ.bindIfElse(a,[[function(){return!b.readonly.value},[b.readonly]]],function(a){ջժ(a,[ջժ.create,"button",0,[[0,"class","button primary"],[3,"click",function(){b.open()}]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"i",0,[[0,"class","fas fa-share"]]],[ջժ.append])}],[ջժ.append])})),ջժ(a,[ջժ.create,"button",0,[[0,"class","button primary"],[3,"click",function(){b.save()}]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"i",0,[[0,"class","fas fa-play"]]],[ջժ.append])}],[ջժ.append]),ջժ(a,[ջժ.create,"button",0,[[0,"class","button primary"],[3,"click",function(){b.fullscreen()}]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"i",0,[[0,"class","fas fa-expand"]]],[ջժ.append])}],[ջժ.append]),g&&ջժ(a,[ջժ.create,"button",0,[[0,"class","button default"],[3,"click",function(){b.open()}]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"i",0,[[0,"class","fas fa-external-link-alt"]]],[ջժ.append])}],[ջժ.append])}],[ջժ.append])}],[ջժ.append])}],[ջժ.append])}],[ջժ.append]),ջժ(a,[ջժ.create,"div",0,[[0,"class","editor"]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"textarea",0,[[1,"value",b.data.editorSource],[3,"documentappend",function(a,c){b.initSourceEditor(c)}]]],[ջժ.append]),ջթ.bindIfElse(a,[[function(){return b.result.value.error},[b.result]]],function(a){ջժ(a,[ջժ.create,"div",0,[[0,"class","error"]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"message",0,[[4,"",ջթ.bo(function(){return b.result.value.error.message.trim()},[b.result])]]],[ջժ.append])}],[ջժ.append])}),ջթ.bindIfElse(a,[[function(){return b.result.value.warnings&&b.result.value.warnings.length},[b.result,b.result]]],function(a){ջժ(a,[ջժ.create,"div",0,[[0,"class","warning"]]],[ջժ.body,function(a){ջթ.bindEach(a,b.result,function(){return b.result.value.warnings.slice(0,3)},function(a,b){var c=b.message,d=b.position,e=d.line,f=d.column;ջժ(a,[ջժ.create,"div",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"Line ".concat(e+1,", Column ").concat(f,": ").concat(c)])}],[ջժ.append])}),ջթ.bindIfElse(a,[[function(){return 3<b.result.value.warnings.length},[b.result]]],function(a){ջժ(a,[ջժ.create,"div",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.text,ջթ.bo(function(){return"".concat(b.result.value.warnings.length-3," more...")},[b.result])])}],[ջժ.append])})}],[ջժ.append])})}],[ջժ.append])}],[ջժ.append]),ջժ(a,[ջժ.create,"div",0,[[0,"class","top settings"],[5,"show",ջթ.bo(function(){return b.settings.value},[b.settings])]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"div",0,[[2,"height","100%"],[2,"background","white"],[2,"padding","16px"],[2,"overflow-y","auto"]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"div",0,[[2,"float","right"]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"button",0,[[0,"class","button danger"],[3,"click",function(){b.settings.value=!1}]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"i",0,[[0,"class","fas fa-times"]]],[ջժ.append])}],[ջժ.append])}],[ջժ.append]),ջժ(a,[ջժ.create,"h3",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"Settings"])}],[ջժ.append]),ջժ(a,[ջժ.create,"label",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"input",0,[]],[ջժ.bind,["checkbox","",b.debug,function(a){b.debug=a}]],[ջժ.append]),ջժ(a,[ջժ.text," Debug\n\t\t\t\t\t"])}],[ջժ.append]),ջժ(a,[ջժ.create,"label",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"input",0,[]],[ջժ.bind,["checkbox","",b.es6,function(a){b.es6=a}]],[ջժ.append]),ջժ(a,[ջժ.text," Generate ES6 code\n\t\t\t\t\t"])}],[ջժ.append]),ջժ(a,[ջժ.create,"label",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"input",0,[]],[ջժ.bind,["checkbox","",b.hideResult,function(a){b.hideResult=a}]],[ջժ.append]),ջժ(a,[ջժ.text," Hide compiled code\n\t\t\t\t\t"])}],[ջժ.append]),ջժ(a,[ջժ.nop],[ջժ.body,function(a){var c=[[2,"width","100%"],[1,"disabled",ջթ.bo(function(){return b.readonly.value},[b.readonly])]];ջժ(a,[ջժ.create,"h4",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"Description"])}],[ջժ.append]),ջժ(a,[ջժ.create,"textarea",0,[].concat(c,[[0,"class","input"]])],[ջժ.bind,["value","::change",ջթ.bo(function(){return b.data.description.value},[b.data.description]),function(a){b.data.description.value=a}]],[ջժ.append]),ջժ(a,[ջժ.create,"h4",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"Mode"])}],[ջժ.append]),ջժ(a,[ջժ.create,"input",0,[].concat(c,[[0,"class","input"],[0,"placeholder","Mode"]])],[ջժ.bind,["value","::change",ջթ.bo(function(){return b.data.mode.value},[b.data.mode]),function(a){b.data.mode.value=a}]],[ջժ.append]),ջժ(a,[ջժ.create,"h4",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"Header"])}],[ջժ.append]),ջժ(a,[ջժ.create,"textarea",0,[].concat(c,[[0,"class","input font-mono"],[0,"placeholder","e.g. <script src=\"example.js\"></script>"],[0,"rows",6]])],[ջժ.bind,["value","::change",ջթ.bo(function(){return b.data.head.value},[b.data.head]),function(a){b.data.head.value=a}]],[ջժ.append])}]),ջժ(a,[ջժ.create,"h4",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"Saved snippets"])}],[ջժ.append]),ջժ(a,[ջժ.create,"table",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"tr",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"th",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"Name"])}],[ջժ.append]),ջժ(a,[ջժ.create,"th",0,[[0,"width",1]]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"Size"])}],[ջժ.append]),ջժ(a,[ջժ.create,"th",0,[[0,"width",1]]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"Modified"])}],[ջժ.append]),ջժ(a,[ջժ.create,"th",0,[[0,"width",1]]],[ջժ.append])}],[ջժ.append]),ջթ.bindEach(a,b.snippets,function(){return b.snippets.value},function(a,c){var d=c.id,e=c.name,f=c.source,g=c.modified;ջժ(a,[ջժ.create,"tr",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"td",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"".concat(e)])}],[ջժ.append]),ջժ(a,[ջժ.create,"td",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"".concat(f.length)])}],[ջժ.append]),ջժ(a,[ջժ.create,"td",0,[[0,"class","nowrap"]]],[ջժ.body,function(a){ջժ(a,[ջժ.text,"".concat(new Date(g).toLocaleString())])}],[ջժ.append]),ջժ(a,[ջժ.create,"td",0,[]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"div",0,[[0,"class","buttons"]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"button",0,[[0,"class","button primary"],[3,"click",function(){b.load(d)}]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"i",0,[[0,"class","fas fa-play"]]],[ջժ.append])}],[ջժ.append]),ջժ(a,[ջժ.create,"button",0,[[0,"class","button danger"],[3,"click",function(){b.remove(e,d)}]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"i",0,[[0,"class","fas fa-trash"]]],[ջժ.append])}],[ջժ.append])}],[ջժ.append])}],[ջժ.append])}],[ջժ.append])})}],[ջժ.append])}],[ջժ.append])}],[ջժ.append]),ջժ(a,[ջժ.create,"div",0,[[0,"class","bottom"]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"div",0,[[0,"class","frame"]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"iframe",0,[[0,"srcdoc",ջթ.bo(function(){return b.srcdoc.value},[b.srcdoc])]]],[ջժ.append])}],[ջժ.append]),ջժ(a,[ջժ.create,"div",0,[[0,"class","source"]]],[ջժ.body,function(a){ջժ(a,[ջժ.create,"textarea",0,[[1,"value",b.result.value.source&&b.result.value.source.contentOnly||""],[3,"documentappend",function(a,c){b.initResultEditor(c)}]]],[ջժ.append])}],[ջժ.append])}],[ջժ.append])}],[ջժ.append])}}],[{key:"style",value:function style(){var a=ջթ.cfa(ջի,arguments,0);return ջժ(a,[ջժ.create,"style",0,[]],[ջժ.body,function(a){ջթ.cabs(a,0,function(a){a.value("position","absolute"),a.value("top, bottom, left, right","0");var b=a.select(".top, .bottom");b.value("position","absolute");var c=a.select("&[data-orientation='x']"),d=c.select(".top, .bottom");d.value("top, bottom","0"),d.value("width","50%");var e=c.select(".top");e.value("left","0"),e.value("border-right","2px solid transparent");var f=c.select(".bottom");f.value("right","0"),f.value("border-left","2px solid transparent");var g=a.select("&[data-orientation='y']"),h=g.select(".top, .bottom");h.value("left, right","0"),h.value("height","50%");var i=g.select(".top");i.value("top","0"),i.value("border-bottom","2px solid transparent");var j=g.select(".bottom");j.value("bottom","0"),j.value("border-top","2px solid transparent");var k=a.select(".top"),l=k.select(".actions, .editor");l.value("position","absolute"),l.value("left, right","0");var m=k.select(".actions");m.value("top","0"),m.value("height","64px"),m.value("border-bottom","2px solid transparent");var n=m.select("& > div");n.value("background","white"),n.value("height","100%"),n.value("padding","0 12px"),n.value("display","flex"),n.value("justify-content","space-between");var o=n.select(".left, .right");o.value("display","flex"),o.value("align-items","center");var p=o.select("& > * + *");p.value("margin-left","12px");var q=k.select(".editor");q.value("top","64px"),q.value("bottom","0"),q.value("border-top","2px solid transparent");var r=q.select(".error, .warning");r.value("position","absolute"),r.value("bottom, left, right","0"),r.value("padding","12px"),r.value("color","white"),r.value("font-family","Consolas, monospace"),r.value("white-space","pre-wrap"),r.value("z-index","4");var s=r.select("code");s.value("background","rgba(255, 255, 255, .125)");var t=q.select(".error");t.value("background","#e74c3c");var u=q.select(".warning");u.value("background","#ffcd02");var v=u.select("& > * + *");v.value("margin-top","12px");var w=k.select("&.settings"),x=w.select("label");x.value("display","block");var y=x.select("& + label");y.value("margin-top","8px");var z=w.select("table");z.value("width","100%"),z.value("border-collapse","collapse");var A=z.select("th, td");A.value("padding","4px 8px");var B=z.select("td");B.value("border-top","1px solid #ddd");var C=z.select("tr th:first-child");C.value("text-align","left");var D=z.select("tr td:nth-child(2), tr td:nth-child(3)");D.value("text-align","center");var E=a.select(".bottom"),F=E.select(".frame, .source");F.value("position","absolute"),F.value("height","50%"),F.value("left, right","0");var G=E.select(".frame");G.value("width","100%"),G.value("top","0"),G.value("border-bottom","2px solid transparent");var H=G.select("iframe");H.value("width, height","100%"),H.value("margin","0"),H.value("border","0"),H.value("background","white");var I=E.select(".source");I.value("bottom","0"),I.value("border-top","2px solid transparent");var J=a.select(".CodeMirror");J.value("background","white !important");var K=a.select("&.hide-result"),L=K.select(".bottom"),M=L.select(".frame");M.value("height","100%"),M.value("border-bottom-width","0");var N=L.select(".source");N.value("display","none")},[],[])}],[ջժ.append])}}]),Sandbox}();